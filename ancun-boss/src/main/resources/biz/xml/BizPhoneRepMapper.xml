<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ancun.boss.persistence.biz.mapper.BizPhoneRepMapper" >

  <!-- 黑名单列表 -->
  <select id="blackUserInfos" resultType="com.ancun.boss.persistence.model.BlackUserInfo" >
    select * from BLACK_USER_INFO
  </select>

  <!-- 批量增加号码库 -->
  <insert id="insertPhoneRepBatch" parameterType="java.util.List" >
    insert into PHONE_REPOSITORY
    (
      ID, PHONE, GET_TIME, PHONE_SOURCE,
      FILTER_OVER, PAYPHONE, BIZ_NAME, CLEAN_STATUS
    )
    values
    <foreach collection ="list" item="phoneRep" index= "index" separator =",">
    (
      #{phoneRep.id}, #{phoneRep.phone}, #{phoneRep.getTime}, #{phoneRep.phoneSource},
      #{phoneRep.filterOver}, #{phoneRep.payphone}, #{phoneRep.bizName}, #{phoneRep.cleanStatus}
    )
    </foreach >
  </insert>

  <!-- 批量修改号码库 -->
  <update id="updatePhoneRepBatch" parameterType="java.util.List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <foreach collection ="list" item="phoneRep" index= "index" separator =";">
      update PHONE_REPOSITORY
      set
        <if test="phoneRep.status != null and phoneRep.status !=''" >
            STATUS = #{phoneRep.status},
        </if>
        <if test="phoneRep.filterOver != null and phoneRep.filterOver !=''" >
            FILTER_OVER = #{phoneRep.filterOver},
        </if>
        <if test="phoneRep.payphone != null and phoneRep.payphone !=''" >
            PAYPHONE = #{phoneRep.payphone},
        </if>
        <if test="phoneRep.cleanStatus != null and phoneRep.cleanStatus !=''" >
            CLEAN_STATUS = #{phoneRep.cleanStatus},
        </if>
        DIVIDTONO = #{phoneRep.dividtono},
        DIVIDTONAME = #{phoneRep.dividtoname},
        DIVIDTIME = #{phoneRep.dividtime},
        DIVIDNUMBER = #{phoneRep.dividnumber}
      where ID = #{phoneRep.id}
    </foreach >
  </update>

  <!-- 批量增加导入失败记录 -->
  <insert id="insertImportFailedRecordBatch" parameterType="java.util.List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <selectKey resultType="long" keyProperty="id" order="AFTER">
        SELECT LAST_INSERT_ID()
    </selectKey>
    insert into IMPORT_FAILED_RECORD
    (
      MENUNO, MENUNAME, FUNCNAME,
      IMPORT_TIME, FAILED_REMARK, USERNO
    )
    values
    <foreach collection ="list" item="item" index= "index" separator =",">
    (
      #{item.menuno,jdbcType=VARCHAR}, #{item.menuname,jdbcType=VARCHAR}, #{item.funcname,jdbcType=VARCHAR},
      #{item.importTime,jdbcType=VARCHAR}, #{item.failedRemark,jdbcType=VARCHAR}, #{item.userno,jdbcType=VARCHAR}
    )
    </foreach >
  </insert>

  <!-- 查询取得号码库列表 -->
  <select id="notPayPhoneReps" parameterType="java.lang.String"
          resultType="com.ancun.boss.persistence.model.PhoneRepository">
        SELECT
            *
        FROM PHONE_REPOSITORY T1
        WHERE 1 = 1
        AND T1.PHONE_SOURCE = #{phoneSource}
        AND T1.FILTER_OVER = 'YES'
  </select>

  <!-- 查询取得除了指定批次外的其他批次列表 -->
  <select id="phoneSourceHelps" parameterType="java.lang.String"
            resultType="com.ancun.boss.persistence.model.PhoneSourceHelp">
        SELECT
          ID AS id,
          BIZ_NAME AS bizName,
          GET_TIME AS getTime,
          PHONE_SOURCE AS phoneSource
        FROM PHONE_SOURCE_HELP T1
        WHERE 1 = 1
        AND T1.PHONE_SOURCE != #{phoneSource}
  </select>

  <!-- 查询获取时间下拉框列表 -->
  <select id="getTimeOptions" parameterType="java.lang.String"
          resultType="com.ancun.boss.pojo.Option">
        SELECT DISTINCT
            GET_TIME AS ID,
            DATE_FORMAT(GET_TIME, '%Y年%m月%d日') AS TEXT
        FROM
            PHONE_SOURCE_HELP
        WHERE BIZ_NAME = #{business}
  </select>

  <!-- 查询取得号码库列表 -->
  <select id="phoneReps" parameterType="com.ancun.boss.pojo.phoneResp.PhoneRespInput"
          resultType="com.ancun.boss.pojo.phoneResp.PhoneRepInfo">
        SELECT
            T1.phone,
            T3.NAME AS bizName,
            T1.GET_TIME AS getTime,
            T1.PHONE_SOURCE AS phoneSource,
            T2.NAME AS status,
            T1.FILTER_OVER AS filterOver,
            T4.NAME AS cleanStatus,
            T1.payphone,
            T1.dividtoname,
            T1.dividtime,
            T1.MARKET_STATUS AS marketStatus,
            T1.MARKET_TIME AS marketTime
        FROM PHONE_REPOSITORY T1
        LEFT JOIN SYSTEM_BASIC_CONFIG T2 ON T1.STATUS = T2.`CODE` AND T2.MOUDLECODE='FILTER_LEVEL'
        LEFT JOIN SYSTEM_BASIC_CONFIG T3 ON T1.BIZ_NAME = T3.`CODE` AND T3.MOUDLECODE='BIZ-NAME'
        LEFT JOIN SYSTEM_BASIC_CONFIG T4 ON T1.CLEAN_STATUS = T4.`CODE` AND T4.MOUDLECODE='CLEAN_STATUS'
        WHERE 1 = 1
        <if test="status != null and status !=''" >
          AND T1.STATUS = #{status}
        </if>
        <if test="business != null and business !=''" >
            AND T1.BIZ_NAME = #{business}
        </if>
        <if test="phone != null and phone !=''" >
            AND T1.PHONE LIKE CONCAT('%', #{phone}, '%')
        </if>
        <if test="getTime != null and getTime !=''" >
            AND T1.GET_TIME = #{getTime}
        </if>
        <if test="filterOver != null and filterOver !=''" >
            AND T1.FILTER_OVER = #{filterOver}
        </if>
        <if test="payphone != null and payphone !=''" >
            AND T1.PAYPHONE = #{payphone}
        </if>
        ORDER BY T1.GET_TIME DESC
  </select>

  <!-- 取得所有需分配的批次 -->
  <select id="phoneSources" resultType="java.lang.String">
    SELECT DISTINCT
        PHONE_SOURCE
    FROM
        PHONE_REPOSITORY
    WHERE
        DIVIDTONO IS NULL
    AND STATUS = '0'
  </select>

  <!-- 根据批次取得电话数量 -->
  <select id="countDividPhonesByPhoneSource" resultType="java.lang.Integer" parameterType="com.ancun.boss.pojo.phoneResp.CountPhoneInput" >
    SELECT
        COUNT(DISTINCT phone)
    FROM
        PHONE_REPOSITORY
    WHERE
        BIZ_NAME = #{business}
    AND GET_TIME = #{getTime}
    AND FILTER_OVER = 'YES'
    AND STATUS = '0'
    AND DIVIDTONO IS NULL
  </select>

  <!-- 根据批次取得用于分配的电话列表 -->
  <select id="phonesForDivid" resultType="com.ancun.boss.persistence.model.PhoneRepository" parameterType="com.ancun.boss.pojo.phoneResp.CountPhoneInput" >
    SELECT
        ID
    FROM
        PHONE_REPOSITORY
    WHERE
        BIZ_NAME = #{business}
    AND GET_TIME = #{getTime}
    AND FILTER_OVER = 'YES'
    AND STATUS = '0'
    AND DIVIDTONO IS NULL
  </select>

</mapper>